#!/bin/bash

# md2docx - Convert Markdown to DOCX using pandoc
# Copyright (c) 2025
# 
# A comprehensive tool for converting Markdown files to Microsoft Word (DOCX) format
# using pandoc with customizable templates and flexible input/output options.

set -euo pipefail

# Script directory and template path
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_TEMPLATE_PATH="$SCRIPT_DIR/pandoc-template.docx"

# Default values
INPUT_FILE=""
OUTPUT_FILE=""
TEMPLATE_FILE="$DEFAULT_TEMPLATE_PATH"
VERBOSE=false
PANDOC_ARGS=""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" >&2
}

# Function to show usage information
show_help() {
    cat << EOF
md2docx - Convert Markdown to DOCX using pandoc

USAGE:
    md2docx [OPTIONS] [INPUT_FILE]

DESCRIPTION:
    Converts Markdown files to Microsoft Word (DOCX) format using pandoc.
    Input can be provided via stdin or as a file argument.
    Output can be written to stdout or to a specified file.

OPTIONS:
    -o, --output FILE       Output file path (default: stdout)
    -t, --template FILE     Custom pandoc reference document template
                           (default: ../share/pandoc/pandoc-template.docx)
    --no-template          Skip template usage (use pandoc defaults)
    -v, --verbose          Enable verbose output
    -h, --help             Show this help message
    --pandoc-args ARGS     Additional arguments to pass to pandoc

EXAMPLES:
    # Convert from stdin to stdout
    echo "# Hello World" | md2docx

    # Convert file to stdout
    md2docx input.md

    # Convert file to specific output
    md2docx input.md -o output.docx

    # Use custom template
    md2docx input.md -o output.docx -t custom-template.docx

    # Verbose mode with additional pandoc options
    md2docx input.md -o output.docx -v --pandoc-args "--toc --number-sections"

INPUT FORMATS:
    The tool accepts GitHub Flavored Markdown (GFM) input, supporting:
    - Headers, paragraphs, and text formatting
    - Lists (ordered and unordered)
    - Code blocks and inline code
    - Tables
    - Links and images
    - Blockquotes
    - Strikethrough text

TEMPLATE:
    By default, the tool looks for a pandoc reference document at:
    $DEFAULT_TEMPLATE_PATH

    You can specify a custom template using the -t/--template option.
    The template should be a valid DOCX file that pandoc can use as a reference.

DEPENDENCIES:
    - pandoc (required for conversion)

EXIT CODES:
    0   Success
    1   General error
    2   Missing dependencies
    3   Invalid arguments
    4   File not found

AUTHOR:
    Created for efficient Markdown to DOCX conversion workflows.

EOF
}

# Function to check if required tools are available
check_dependencies() {
    if ! command -v pandoc >/dev/null 2>&1; then
        log_error "pandoc is not installed or not in PATH"
        log_error "Please install pandoc: https://pandoc.org/installing.html"
        return 2
    fi

    # Check template file if specified
    if [[ -n "$TEMPLATE_FILE" && ! -f "$TEMPLATE_FILE" ]]; then
        if [[ "$TEMPLATE_FILE" == "$DEFAULT_TEMPLATE_PATH" ]]; then
            # Default template not found - warn but continue
            log_warn "Default template not found: $TEMPLATE_FILE"
            log_warn "Continuing without template (pandoc will use default formatting)"
            TEMPLATE_FILE=""
        else
            # Custom template specified but not found - error
            log_error "Template file not found: $TEMPLATE_FILE"
            return 4
        fi
    fi

    return 0
}

# Function to parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -o|--output)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires an argument"
                    exit 3
                fi
                OUTPUT_FILE="$2"
                shift 2
                ;;
            -t|--template)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires an argument"
                    exit 3
                fi
                TEMPLATE_FILE="$2"
                shift 2
                ;;
            --no-template)
                TEMPLATE_FILE=""
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --pandoc-args)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires an argument"
                    exit 3
                fi
                PANDOC_ARGS="$2"
                shift 2
                ;;
            -*)
                log_error "Unknown option: $1"
                log_error "Use -h or --help for usage information"
                exit 3
                ;;
            *)
                if [[ -n "$INPUT_FILE" ]]; then
                    log_error "Multiple input files specified: '$INPUT_FILE' and '$1'"
                    exit 3
                fi
                INPUT_FILE="$1"
                shift
                ;;
        esac
    done
}

# Function to validate input file
validate_input() {
    if [[ -n "$INPUT_FILE" ]]; then
        if [[ ! -f "$INPUT_FILE" ]]; then
            log_error "Input file not found: $INPUT_FILE"
            exit 4
        fi
        if [[ ! -r "$INPUT_FILE" ]]; then
            log_error "Cannot read input file: $INPUT_FILE"
            exit 4
        fi
    fi
}

# Function to build pandoc command
build_pandoc_command() {
    local cmd="pandoc"
    
    # Input format
    cmd="$cmd --from=gfm"
    
    # Output format
    cmd="$cmd --to=docx"
    
    # Reference document (template)
    if [[ -n "$TEMPLATE_FILE" ]]; then
        cmd="$cmd --reference-doc=\"$TEMPLATE_FILE\""
    fi
    
    # Additional pandoc arguments
    if [[ -n "$PANDOC_ARGS" ]]; then
        cmd="$cmd $PANDOC_ARGS"
    fi
    
    # Input source
    if [[ -n "$INPUT_FILE" ]]; then
        cmd="$cmd \"$INPUT_FILE\""
    else
        cmd="$cmd -"  # Read from stdin
    fi
    
    # Output destination
    if [[ -n "$OUTPUT_FILE" ]]; then
        cmd="$cmd --output=\"$OUTPUT_FILE\""
    else
        cmd="$cmd --output=-"  # Write to stdout
    fi
    
    echo "$cmd"
}

# Function to perform the conversion
convert_markdown() {
    local pandoc_cmd
    pandoc_cmd=$(build_pandoc_command)
    
    if [[ "$VERBOSE" == true ]]; then
        log_info "Template file: ${TEMPLATE_FILE:-none}"
        log_info "Input: ${INPUT_FILE:-stdin}"
        log_info "Output: ${OUTPUT_FILE:-stdout}"
        log_info "Pandoc command: $pandoc_cmd"
    fi
    
    # Execute pandoc command
    if eval "$pandoc_cmd"; then
        if [[ "$VERBOSE" == true && -n "$OUTPUT_FILE" ]]; then
            log_success "Conversion completed: $OUTPUT_FILE"
        fi
        return 0
    else
        log_error "Conversion failed"
        return 1
    fi
}

# Main function
main() {
    # Parse command line arguments
    parse_args "$@"
    
    # Check dependencies
    if ! check_dependencies; then
        exit $?
    fi
    
    # Validate input
    validate_input
    
    # Perform conversion
    if ! convert_markdown; then
        exit 1
    fi
}

# Run main function with all arguments
main "$@"
